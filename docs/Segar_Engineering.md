# Segar Engineering and Deployment Instructions

This document describes the typical development process, type definition, dependency management, link configuration and deployment methods of the Segar project.

## 1. Typical development process

1. **Type definition**: define msg/srv/action or use Protobuf
2. **Dependency Management**: Configure depend_libs.txt and introduce third_party, msg_tool, and segar library dependencies
3. **Code and Configuration**: Writing business code, CMake configuration
4. **Compilation and Deployment**: Build, install, run

## 2. Type definition

### 2.1 Type system overview

Segar supports two types of messages:

- **Protobuf message**: defined using `.proto`
- **ROS 2 style custom message**: processed using msg_tool, compatible with ROS 2 type definition, and extended

The following description is only for msg_tool.

### 2.2 Type definition specifications

File naming follows the ROS 2 specification and is divided into three types: `msg`, `srv`, and `action`. Take the `String` message under the namespace `example` as an example:

```
src/type_src/example/msg/String.msg
```

- Use CamelCase for filenames (such as `String.msg`)
- `.msg` file basename is the Segar Message type name
- The directory path is the namespace, such as `example/msg/String.msg` → `example::msg::String`

The definition syntax of `srv` and `action` is the same as ROS 2, so no further details will be given.

### 2.3 Type processing (msg_tool)

msg_tool provides cmake interface for type compilation:

```cmake
include(msg_tool_generate_code.cmake)
MsgToolCompile(${CMAKE_CURRENT_LIST_DIR}/type_src ${CMAKE_BINARY_DIR}/generate example_msg)
```

| parameter | illustrate |
|------|------|
| 1st parameter | The directory where the type file is located (such as `type_src`) |
| 2nd parameter | Generate code output directory (such as `generate`) |
| 3rd parameter | Library name generated by type code compilation (such as `example_msg`) |

## 3. Dependency management

### 3.1 Dependency list

Specified in `depend_libs.txt`:

```
third_party 2.0.0
msg_tool 2.0.0
segar 2.0.0
```

### 3.2 Third-party libraries included in third_party

| Library name | branch/version |
|------|-----------|
| nlohmann_json | v3.11.3 |
| tinyxml2 | 8.0.0 |
| gflags | v2.2.0 |
| glog | v0.4.0 |
| googletest | release-1.10.0 |
| protobuf | v3.14.0 |
| asio | asio-1-18-1 |
| websocketpp | 0.8.2 |
| foonathan_memory_vendor | v1.3.1 |
| Fast-CDR | v2.2.2 |
| Fast-DDS | v2.14.3 |
| yaml-cpp | 0.8.0 |
| Fast-DDS-Gen | v3.3.1 |

### 3.3 Dependency introduction

In `CMakeLists.txt`:

```cmake
include(${CMAKE_SOURCE_DIR}/cmake/GetThirdParty.cmake)
load_dependencies("${PLATFORM_NAME}" "depend_libs.txt")
```

- `PLATFORM_NAME`: platform identification (such as `x86_64`, `orin`)
- `depend_libs.txt`: Dependency version configuration file path

Dependencies will be automatically pulled from Gitee. Users can choose to continue or modify this dependency management method according to the actual needs of the project.

## 4. Link Segar

In `CMakeLists.txt`:

```cmake
list(APPEND CMAKE_MODULE_PATH "${THIRD_PARTY_PREFIX}/share/cmake/segar")
find_package(RtiSegar REQUIRED)
target_link_libraries(${TARGET_NAME} PRIVATE rti::segar)
```

where `THIRD_PARTY_PREFIX` is usually `install/${PLATFORM_NAME}/third_party`.

## 5. Deployment

### 5.1 Typical deployment structure

```
output/
├── config/ # segar public configuration, used by segar cli tool
│   ├── segar.pb.conf
│   ├── record_config.conf
│   └── ...
├── third_party/ # Third-party libraries, such as segar’s bin files, lib files, etc. will be stored here
├── segar_setup.bash # segar environment variable, used by segar cli tool
├── topic_example/
│   └── topic_talker/
│       ├── bin/
│       │   └── topic_talker
│       ├── config/
│ │ └── segar.pb.conf #Configuration file used by user processes
│       └── scripts/
│ └── launch.sh # Startup script used by user processes
```


### 5.2 Deployment instructions

### 5.3 Segar configuration (segar.pb.conf)

Taking `topic_talker` as an example, the original content and comments of `config/segar.pb.conf` are as follows. Post-deployment path: `topic_example/topic_talker/config/segar.pb.conf`.

```protobuf
# === Transport configuration ===
transport_conf {
#Participant attributes: lease period, release cycle, port, etc.
  participant_attr {
lease_duration: 12 # Lease period (seconds)
announcement_period: 3 # Discover the announcement period
domain_id_gain: 250 # Calculate the offset base of the multicast port
port_base: 7400 # Port baseline
  }
# Communication mode: same process/cross-process/cross-host
  communication_mode {
same_proc: INTRA #Same process: INTRA communication method
diff_proc: SHM # Cross-process: shared memory
diff_host: RTPS # Cross-host: RTPS
  }
# Resource limits
  resource_limit {
max_history_depth: 100 # History depth
async_log_flush_interval_ms: 500 # Asynchronous log flush interval
    task_manager_limit {
task_queue_max_num: 1024 # Maximum number of task queues
warning_running_task_num: 64 # Alarm threshold for number of running tasks
    }
  }
}

# === Run mode ===
run_mode_conf {
run_mode: MODE_REALITY #Run mode: real scene
clock_mode: MODE_SEGAR # Clock mode: Segar clock
}

# === Scheduler configuration ===
scheduler_conf {
routine_num: 96 # Number of coroutines
default_proc_num: 5 #Default number of processing threads
threads: [ # Thread configuration
{ name: "shm_disp", policy: "SCHED_OTHER", prio: -2 }, # Shared memory distribution
{ name: "timer", policy: "SCHED_OTHER", prio: -2 } # timer
  ]
}
```

### 5.4 Launch script (launch.sh)

Taking `topic_talker` as an example, the original content and comments of `scripts/launch.sh` are as follows. Post-deployment path: `topic_example/topic_talker/scripts/launch.sh`. Running mode: Execute after `bash scripts/launch.sh` or `source segar_setup.bash`.

```bash
# === Path analysis ===
# SCRIPT_DIR: The directory where the script is located (i.e. scripts/)
# PROJ_DIR: Project root directory (output/), launch.sh is under scripts/, so it is three levels up
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJ_DIR="$SCRIPT_DIR/../../../"

# === Environment variables ===
# LD_LIBRARY_PATH: dynamic library search path, including third_party and segar lib
# PATH: Add the bin directory so that topic_talker can be executed directly
# SEGAR_PATH: sample root directory (including config, bin), the program loads config accordingly
LD_LIBRARY_PATH=$PROJ_DIR/third_party/lib:$PROJ_DIR/lib:$LD_LIBRARY_PATH
PATH=$SCRIPT_DIR/../bin:$PATH
SEGAR_PATH=$SCRIPT_DIR/..
export LD_LIBRARY_PATH PATH SEGAR_PATH

# === Log directory ===
#Create .segar/log, GLOG will write the log to this directory
SEGAR_LOG_DIR_PREFIX="$PROJ_DIR/.segar/log"
echo $SEGAR_LOG_DIR_PREFIX
if [ ! -d "$SEGAR_LOG_DIR_PREFIX" ]; then
    mkdir -p "$SEGAR_LOG_DIR_PREFIX"
fi
export GLOG_log_dir="$SEGAR_LOG_DIR_PREFIX"
export GLOG_alsologtostderr=1 # Also output to stderr
export GLOG_colorlogtostderr=1 # Color log
export GLOG_minloglevel=0 # Minimum log level (INFO)
export sysmo_start=0

# === Segar parameters ===
export SEGAR_DOMAIN_ID=0               # DDS domain id
export SEGAR_IP=127.0.0.1 # Local IP

# === Start program ===
# Optional: gdb --args topic_talker starts in debug mode
topic_talker
```

### 5.5 Preparation before operation

You need to load `source segar_setup.bash` environment variables before running. For more examples and operation instructions, see [Examples](Segar_Examples.md).
